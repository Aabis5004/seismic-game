<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEISMIC KINGDOMS - Rule the Realm</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12141a;
            --bg-hover: #1a1d25;
            --gold: #d4a437;
            --gold-dark: #8b6914;
            --gold-light: #f4d03f;
            --blood: #8b0000;
            --blood-light: #c41e3a;
            --ice: #4a9fff;
            --forest: #228b22;
            --stone: #708090;
            --text: #e8e6e3;
            --text-dim: #7a7a7a;
            --border: #2a2d35;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ========== LOADING SCREEN ========== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-title {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(212, 164, 55, 0.5);
            margin-bottom: 2rem;
        }

        .loading-bar {
            width: 300px;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--gold-dark);
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-light));
            width: 0%;
            transition: width 0.3s;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
            100% { filter: brightness(1); }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* ========== MAIN MENU ========== */
        #main-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, rgba(10,10,15,0.95) 0%, rgba(20,15,10,0.95) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%230a0a0f" width="100" height="100"/><circle fill="%23d4a437" cx="50" cy="50" r="1" opacity="0.1"/></svg>');
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #main-menu.active { display: flex; }

        .menu-logo {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 4px 20px rgba(212, 164, 55, 0.4), 0 0 60px rgba(212, 164, 55, 0.2);
            margin-bottom: 0.5rem;
            letter-spacing: 0.1em;
        }

        .menu-subtitle {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--text-dim);
            letter-spacing: 0.5em;
            margin-bottom: 3rem;
        }

        .menu-tagline {
            max-width: 500px;
            text-align: center;
            color: var(--text-dim);
            line-height: 1.8;
            margin-bottom: 3rem;
            font-style: italic;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            font-family: 'Cinzel', serif;
            padding: 1rem 3rem;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,164,55,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }

        .btn:hover {
            background: var(--gold);
            color: var(--bg-dark);
            box-shadow: 0 0 30px rgba(212, 164, 55, 0.4);
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--bg-dark);
        }

        .btn-small {
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
        }

        /* ========== AUTH MODAL ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 0.4rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.9rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .modal-error {
            background: rgba(139, 0, 0, 0.2);
            border: 1px solid var(--blood);
            color: var(--blood-light);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }

        .modal-error.show { display: block; }

        /* ========== GAME UI ========== */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        #game-container.active { display: block; }

        /* Top HUD */
        .game-hud-top {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(10,10,15,0.95) 0%, rgba(10,10,15,0.8) 80%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 100;
        }

        .hud-resources {
            display: flex;
            gap: 1.5rem;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(20, 22, 30, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .resource-icon {
            font-size: 1.2rem;
        }

        .resource-value {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .resource-gold .resource-value { color: var(--gold); }
        .resource-food .resource-value { color: #7cfc00; }
        .resource-iron .resource-value { color: #b0c4de; }
        .resource-troops .resource-value { color: var(--blood-light); }

        .hud-player {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--bg-dark);
        }

        .player-info {
            text-align: right;
        }

        .player-name {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--gold);
        }

        .player-level {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Game Canvas */
        #game-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #game-canvas:active { cursor: grabbing; }

        /* Bottom Action Bar */
        .game-hud-bottom {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: linear-gradient(0deg, rgba(10,10,15,0.95) 0%, transparent 100%);
            z-index: 100;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .action-btn.active {
            border-color: var(--gold);
            background: rgba(212, 164, 55, 0.1);
        }

        .action-btn-icon { font-size: 1.5rem; }
        .action-btn-label { font-size: 0.6rem; color: var(--text-dim); margin-top: 0.2rem; }

        /* Side Panel */
        .side-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 280px;
            max-height: calc(100vh - 160px);
            background: rgba(18, 20, 26, 0.95);
            border: 1px solid var(--border);
            border-radius: 10px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .side-panel.active { display: block; }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold);
        }

        .panel-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .panel-close:hover { color: var(--text); }

        .panel-body {
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Building Card */
        .building-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .building-card:hover {
            border-color: var(--gold-dark);
            transform: translateX(5px);
        }

        .building-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .building-card-icon { font-size: 1.5rem; }

        .building-card-name {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--text);
        }

        .building-card-level {
            font-size: 0.75rem;
            color: var(--gold);
            margin-left: auto;
        }

        .building-card-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .building-card-cost {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
        }

        .cost-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .cost-item.affordable { color: var(--forest); }
        .cost-item.expensive { color: var(--blood-light); }

        /* Unit Card */
        .unit-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .unit-icon { font-size: 2rem; }

        .unit-info { flex: 1; }

        .unit-name {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--text);
        }

        .unit-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .unit-count {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        /* Minimap */
        .minimap {
            position: fixed;
            bottom: 80px;
            left: 10px;
            width: 150px;
            height: 150px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            z-index: 100;
            overflow: hidden;
        }

        .minimap-canvas {
            width: 100%;
            height: 100%;
        }

        /* Selection Info */
        .selection-info {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(18, 20, 26, 0.95);
            border: 1px solid var(--gold-dark);
            border-radius: 10px;
            padding: 1rem 2rem;
            z-index: 100;
            display: none;
            text-align: center;
        }

        .selection-info.active { display: block; }

        .selection-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 0.25rem;
        }

        .selection-desc {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--gold-dark);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            z-index: 200;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        .notification-title {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 0.25rem;
        }

        .notification-text {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Chat */
        .chat-container {
            position: fixed;
            bottom: 80px;
            right: 10px;
            width: 300px;
            height: 200px;
            background: rgba(18, 20, 26, 0.9);
            border: 1px solid var(--border);
            border-radius: 10px;
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .chat-container.active { display: flex; }

        .chat-messages {
            flex: 1;
            padding: 0.75rem;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        .chat-message {
            margin-bottom: 0.5rem;
        }

        .chat-message .sender { color: var(--gold); }
        .chat-message .text { color: var(--text); }

        .chat-input-container {
            display: flex;
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.85rem;
        }

        .chat-input:focus { outline: none; }

        .chat-send {
            padding: 0.75rem 1rem;
            background: var(--gold-dark);
            border: none;
            color: var(--bg-dark);
            cursor: pointer;
        }

        /* Battle Modal */
        .battle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .battle-modal.active { display: flex; }

        .battle-content {
            text-align: center;
        }

        .battle-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--blood-light);
            margin-bottom: 2rem;
            text-shadow: 0 0 30px rgba(196, 30, 58, 0.5);
        }

        .battle-vs {
            display: flex;
            align-items: center;
            gap: 3rem;
            margin-bottom: 2rem;
        }

        .battle-side {
            text-align: center;
        }

        .battle-army-icon { font-size: 4rem; margin-bottom: 0.5rem; }
        .battle-army-name { font-family: 'Cinzel', serif; color: var(--gold); }
        .battle-army-power { color: var(--text-dim); }

        .battle-vs-text {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--blood);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-logo { font-size: 2.5rem; }
            .hud-resources { gap: 0.5rem; }
            .resource { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
            .side-panel { width: 260px; }
            .minimap { width: 100px; height: 100px; }
            .chat-container { width: 250px; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <h1 class="loading-title">SEISMIC KINGDOMS</h1>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <p class="loading-text" id="loadingText">Forging the realm...</p>
    </div>

    <!-- Main Menu -->
    <div id="main-menu">
        <h1 class="menu-logo">SEISMIC KINGDOMS</h1>
        <p class="menu-subtitle">Rule the Realm</p>
        <p class="menu-tagline">
            "In the game of thrones, you win or you die. Build your kingdom, forge alliances, 
            command armies, and conquer the realm. The Iron Throne awaits."
        </p>
        <div class="menu-buttons">
            <button class="btn btn-primary" onclick="showAuthModal('login')">‚öîÔ∏è ENTER THE REALM</button>
            <button class="btn" onclick="playAsGuest()">üëÅÔ∏è PLAY AS WANDERER</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2 class="modal-title" id="authTitle">üè∞ Enter Your Name</h2>
            <div class="modal-error" id="authError"></div>
            <form id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label>LORD/LADY NAME</label>
                    <input type="text" id="authUsername" placeholder="Your noble name" required>
                </div>
                <div class="form-group">
                    <label>SECRET WORD</label>
                    <input type="password" id="authPassword" placeholder="Your secret" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">CLAIM YOUR THRONE</button>
            </form>
            <p style="text-align:center;margin-top:1rem;color:var(--text-dim);font-size:0.85rem;cursor:pointer" onclick="closeModal()">‚Üê Return</p>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container">
        <!-- Top HUD -->
        <div class="game-hud-top">
            <div class="hud-resources">
                <div class="resource resource-gold">
                    <span class="resource-icon">üí∞</span>
                    <span class="resource-value" id="goldAmount">1000</span>
                </div>
                <div class="resource resource-food">
                    <span class="resource-icon">üåæ</span>
                    <span class="resource-value" id="foodAmount">500</span>
                </div>
                <div class="resource resource-iron">
                    <span class="resource-icon">‚öîÔ∏è</span>
                    <span class="resource-value" id="ironAmount">200</span>
                </div>
                <div class="resource resource-troops">
                    <span class="resource-icon">üõ°Ô∏è</span>
                    <span class="resource-value" id="troopsAmount">50</span>
                </div>
            </div>
            <div class="hud-player">
                <div class="player-info">
                    <div class="player-name" id="playerName">Lord Unknown</div>
                    <div class="player-level">Level <span id="playerLevel">1</span> ‚Ä¢ <span id="kingdomName">Unnamed Kingdom</span></div>
                </div>
                <div class="player-avatar" id="playerAvatar">?</div>
            </div>
        </div>

        <!-- Game Canvas -->
        <canvas id="game-canvas"></canvas>

        <!-- Minimap -->
        <div class="minimap">
            <canvas class="minimap-canvas" id="minimap-canvas"></canvas>
        </div>

        <!-- Bottom Action Bar -->
        <div class="game-hud-bottom">
            <div class="action-btn" onclick="togglePanel('build')" id="btn-build">
                <span class="action-btn-icon">üèóÔ∏è</span>
                <span class="action-btn-label">Build</span>
            </div>
            <div class="action-btn" onclick="togglePanel('army')" id="btn-army">
                <span class="action-btn-icon">‚öîÔ∏è</span>
                <span class="action-btn-label">Army</span>
            </div>
            <div class="action-btn" onclick="togglePanel('kingdom')" id="btn-kingdom">
                <span class="action-btn-icon">üëë</span>
                <span class="action-btn-label">Kingdom</span>
            </div>
            <div class="action-btn" onclick="togglePanel('alliance')" id="btn-alliance">
                <span class="action-btn-icon">ü§ù</span>
                <span class="action-btn-label">Alliance</span>
            </div>
            <div class="action-btn" onclick="toggleChat()" id="btn-chat">
                <span class="action-btn-icon">üí¨</span>
                <span class="action-btn-label">Chat</span>
            </div>
        </div>

        <!-- Side Panel: Build -->
        <div class="side-panel" id="panel-build">
            <div class="panel-header">
                <span class="panel-title">üèóÔ∏è Construction</span>
                <button class="panel-close" onclick="closePanel()">‚úï</button>
            </div>
            <div class="panel-body" id="buildingsList"></div>
        </div>

        <!-- Side Panel: Army -->
        <div class="side-panel" id="panel-army">
            <div class="panel-header">
                <span class="panel-title">‚öîÔ∏è Your Army</span>
                <button class="panel-close" onclick="closePanel()">‚úï</button>
            </div>
            <div class="panel-body" id="armyList"></div>
        </div>

        <!-- Side Panel: Kingdom -->
        <div class="side-panel" id="panel-kingdom">
            <div class="panel-header">
                <span class="panel-title">üëë Kingdom Overview</span>
                <button class="panel-close" onclick="closePanel()">‚úï</button>
            </div>
            <div class="panel-body" id="kingdomInfo"></div>
        </div>

        <!-- Side Panel: Alliance -->
        <div class="side-panel" id="panel-alliance">
            <div class="panel-header">
                <span class="panel-title">ü§ù Alliances</span>
                <button class="panel-close" onclick="closePanel()">‚úï</button>
            </div>
            <div class="panel-body" id="allianceInfo"></div>
        </div>

        <!-- Chat -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message"><span class="sender">[System]:</span> <span class="text">Welcome to the Realm!</span></div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Send message...">
                <button class="chat-send" onclick="sendChat()">‚û§</button>
            </div>
        </div>

        <!-- Selection Info -->
        <div class="selection-info" id="selectionInfo">
            <div class="selection-name" id="selectionName">Castle</div>
            <div class="selection-desc" id="selectionDesc">Your main fortress</div>
        </div>
    </div>

    <!-- Battle Modal -->
    <div class="battle-modal" id="battleModal">
        <div class="battle-content">
            <h2 class="battle-title">‚öîÔ∏è BATTLE COMMENCES ‚öîÔ∏è</h2>
            <div class="battle-vs">
                <div class="battle-side">
                    <div class="battle-army-icon">üè∞</div>
                    <div class="battle-army-name" id="battle-attacker">Your Army</div>
                    <div class="battle-army-power" id="battle-attacker-power">Power: 500</div>
                </div>
                <div class="battle-vs-text">VS</div>
                <div class="battle-side">
                    <div class="battle-army-icon">üè¥</div>
                    <div class="battle-army-name" id="battle-defender">Enemy</div>
                    <div class="battle-army-power" id="battle-defender-power">Power: 300</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startBattle()">‚öîÔ∏è FIGHT!</button>
            <button class="btn" onclick="closeBattle()" style="margin-left:1rem">üè≥Ô∏è Retreat</button>
        </div>
    </div>

<script>
// ============================================================
// GAME CONFIGURATION
// ============================================================
const CONFIG = {
    MAP_SIZE: 2000,
    TILE_SIZE: 100,
    RESOURCE_TICK: 5000, // 5 seconds
};

// ============================================================
// GAME STATE
// ============================================================
const Game = {
    user: null,
    token: null,
    resources: { gold: 1000, food: 500, iron: 200, troops: 50 },
    buildings: [],
    army: { infantry: 30, archers: 15, cavalry: 5 },
    level: 1,
    xp: 0,
    kingdom: { name: 'Unnamed Kingdom', banner: 'üè¥' },
    alliance: null,
    camera: { x: 0, y: 0, zoom: 1 },
    selectedTile: null,
    isDragging: false,
    lastMouse: { x: 0, y: 0 },
};

// ============================================================
// BUILDING TYPES
// ============================================================
const BUILDINGS = {
    castle: { name: 'Castle', icon: 'üè∞', desc: 'Your main fortress. Upgrade to unlock more buildings.', cost: { gold: 0 }, provides: { defense: 100 }, maxLevel: 10 },
    barracks: { name: 'Barracks', icon: '‚öîÔ∏è', desc: 'Train infantry soldiers here.', cost: { gold: 200, iron: 50 }, provides: { infantry: 5 }, maxLevel: 5 },
    archeryRange: { name: 'Archery Range', icon: 'üèπ', desc: 'Train skilled archers.', cost: { gold: 300, iron: 100 }, provides: { archers: 3 }, maxLevel: 5 },
    stable: { name: 'Stable', icon: 'üê¥', desc: 'Train cavalry units.', cost: { gold: 500, iron: 150 }, provides: { cavalry: 2 }, maxLevel: 5 },
    farm: { name: 'Farm', icon: 'üåæ', desc: 'Produces food for your kingdom.', cost: { gold: 100 }, provides: { food: 10 }, maxLevel: 10 },
    mine: { name: 'Iron Mine', icon: '‚õèÔ∏è', desc: 'Extract iron for weapons and armor.', cost: { gold: 150 }, provides: { iron: 5 }, maxLevel: 10 },
    market: { name: 'Market', icon: 'üè™', desc: 'Generates gold through trade.', cost: { gold: 200 }, provides: { gold: 15 }, maxLevel: 5 },
    watchtower: { name: 'Watchtower', icon: 'üóº', desc: 'Detects incoming enemies.', cost: { gold: 100, iron: 30 }, provides: { vision: 50 }, maxLevel: 3 },
    wall: { name: 'Wall', icon: 'üß±', desc: 'Protects your kingdom.', cost: { gold: 50, iron: 20 }, provides: { defense: 20 }, maxLevel: 5 },
    temple: { name: 'Temple', icon: '‚õ™', desc: 'Unlocks ancient puzzles and prophecies.', cost: { gold: 500 }, provides: { wisdom: 10 }, maxLevel: 3 },
};

// ============================================================
// UNIT TYPES
// ============================================================
const UNITS = {
    infantry: { name: 'Infantry', icon: 'üó°Ô∏è', attack: 10, defense: 15, speed: 1, cost: { gold: 50, food: 20 } },
    archers: { name: 'Archers', icon: 'üèπ', attack: 15, defense: 5, speed: 1, cost: { gold: 80, food: 25 } },
    cavalry: { name: 'Cavalry', icon: 'üê¥', attack: 20, defense: 10, speed: 3, cost: { gold: 150, food: 50, iron: 30 } },
    siege: { name: 'Siege Engine', icon: 'üí£', attack: 50, defense: 5, speed: 0.5, cost: { gold: 500, iron: 200 } },
};

// ============================================================
// LOADING
// ============================================================
window.onload = () => {
    simulateLoading();
};

function simulateLoading() {
    const progress = document.getElementById('loadingProgress');
    const text = document.getElementById('loadingText');
    const steps = [
        { pct: 20, txt: 'Forging the realm...' },
        { pct: 40, txt: 'Raising castles...' },
        { pct: 60, txt: 'Summoning armies...' },
        { pct: 80, txt: 'Preparing for war...' },
        { pct: 100, txt: 'The realm awaits!' },
    ];
    
    let i = 0;
    const interval = setInterval(() => {
        if (i < steps.length) {
            progress.style.width = steps[i].pct + '%';
            text.textContent = steps[i].txt;
            i++;
        } else {
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-menu').classList.add('active');
            }, 500);
        }
    }, 400);
}

// ============================================================
// AUTHENTICATION
// ============================================================
function showAuthModal(type) {
    document.getElementById('authModal').classList.add('active');
}

function closeModal() {
    document.getElementById('authModal').classList.remove('active');
}

function handleAuth(e) {
    e.preventDefault();
    const username = document.getElementById('authUsername').value.trim();
    const password = document.getElementById('authPassword').value;
    
    if (username.length < 2) {
        showAuthError('Name must be at least 2 characters');
        return;
    }
    
    // For now, just start the game
    Game.user = { username, id: Date.now() };
    Game.kingdom.name = username + "'s Kingdom";
    closeModal();
    startGame();
}

function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

function playAsGuest() {
    Game.user = { username: 'Wanderer_' + Math.random().toString(36).substr(2, 5), id: Date.now() };
    Game.kingdom.name = 'Wanderer\'s Camp';
    startGame();
}

// ============================================================
// GAME INITIALIZATION
// ============================================================
function startGame() {
    document.getElementById('main-menu').classList.remove('active');
    document.getElementById('game-container').classList.add('active');
    
    updateUI();
    initCanvas();
    initBuildings();
    startResourceLoop();
    
    notify('Welcome, ' + Game.user.username + '!', 'Your kingdom awaits.');
}

function updateUI() {
    document.getElementById('goldAmount').textContent = formatNumber(Game.resources.gold);
    document.getElementById('foodAmount').textContent = formatNumber(Game.resources.food);
    document.getElementById('ironAmount').textContent = formatNumber(Game.resources.iron);
    document.getElementById('troopsAmount').textContent = formatNumber(getTotalTroops());
    document.getElementById('playerName').textContent = 'Lord ' + Game.user.username;
    document.getElementById('playerLevel').textContent = Game.level;
    document.getElementById('kingdomName').textContent = Game.kingdom.name;
    document.getElementById('playerAvatar').textContent = Game.user.username.charAt(0).toUpperCase();
}

function formatNumber(n) {
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return n;
}

function getTotalTroops() {
    return Game.army.infantry + Game.army.archers + Game.army.cavalry;
}

// ============================================================
// CANVAS & MAP RENDERING
// ============================================================
let canvas, ctx, minimapCanvas, minimapCtx;

function initCanvas() {
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    minimapCanvas = document.getElementById('minimap-canvas');
    minimapCtx = minimapCanvas.getContext('2d');
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Mouse events
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onWheel);
    canvas.addEventListener('click', onClick);
    
    // Touch events
    canvas.addEventListener('touchstart', onTouchStart);
    canvas.addEventListener('touchmove', onTouchMove);
    canvas.addEventListener('touchend', onTouchEnd);
    
    // Center camera on castle
    Game.camera.x = CONFIG.MAP_SIZE / 2 - canvas.width / 2;
    Game.camera.y = CONFIG.MAP_SIZE / 2 - canvas.height / 2;
    
    render();
}

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    minimapCanvas.width = 150;
    minimapCanvas.height = 150;
    render();
}

function render() {
    // Clear
    ctx.fillStyle = '#1a2f1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw grid
    ctx.strokeStyle = 'rgba(100, 150, 100, 0.2)';
    ctx.lineWidth = 1;
    
    const startX = Math.floor(Game.camera.x / CONFIG.TILE_SIZE) * CONFIG.TILE_SIZE - Game.camera.x;
    const startY = Math.floor(Game.camera.y / CONFIG.TILE_SIZE) * CONFIG.TILE_SIZE - Game.camera.y;
    
    for (let x = startX; x < canvas.width; x += CONFIG.TILE_SIZE) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    
    for (let y = startY; y < canvas.height; y += CONFIG.TILE_SIZE) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }
    
    // Draw buildings
    Game.buildings.forEach(b => {
        const screenX = b.x - Game.camera.x;
        const screenY = b.y - Game.camera.y;
        
        if (screenX > -CONFIG.TILE_SIZE && screenX < canvas.width + CONFIG.TILE_SIZE &&
            screenY > -CONFIG.TILE_SIZE && screenY < canvas.height + CONFIG.TILE_SIZE) {
            
            // Building background
            ctx.fillStyle = 'rgba(40, 50, 40, 0.8)';
            ctx.fillRect(screenX, screenY, CONFIG.TILE_SIZE - 4, CONFIG.TILE_SIZE - 4);
            
            // Building border
            ctx.strokeStyle = b === Game.selectedTile ? '#d4a437' : '#4a6a4a';
            ctx.lineWidth = b === Game.selectedTile ? 3 : 1;
            ctx.strokeRect(screenX, screenY, CONFIG.TILE_SIZE - 4, CONFIG.TILE_SIZE - 4);
            
            // Building icon
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(BUILDINGS[b.type].icon, screenX + CONFIG.TILE_SIZE/2 - 2, screenY + CONFIG.TILE_SIZE/2 - 2);
            
            // Level badge
            ctx.fillStyle = '#d4a437';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Lv.' + b.level, screenX + CONFIG.TILE_SIZE/2 - 2, screenY + CONFIG.TILE_SIZE - 15);
        }
    });
    
    // Draw minimap
    renderMinimap();
    
    requestAnimationFrame(render);
}

function renderMinimap() {
    minimapCtx.fillStyle = '#1a2f1a';
    minimapCtx.fillRect(0, 0, 150, 150);
    
    const scale = 150 / CONFIG.MAP_SIZE;
    
    // Draw buildings on minimap
    Game.buildings.forEach(b => {
        minimapCtx.fillStyle = b.type === 'castle' ? '#d4a437' : '#8b8b8b';
        minimapCtx.fillRect(b.x * scale, b.y * scale, 5, 5);
    });
    
    // Draw viewport
    minimapCtx.strokeStyle = '#fff';
    minimapCtx.lineWidth = 1;
    minimapCtx.strokeRect(
        Game.camera.x * scale,
        Game.camera.y * scale,
        canvas.width * scale,
        canvas.height * scale
    );
}

// ============================================================
// MOUSE/TOUCH HANDLERS
// ============================================================
function onMouseDown(e) {
    Game.isDragging = true;
    Game.lastMouse = { x: e.clientX, y: e.clientY };
}

function onMouseMove(e) {
    if (Game.isDragging) {
        const dx = e.clientX - Game.lastMouse.x;
        const dy = e.clientY - Game.lastMouse.y;
        Game.camera.x -= dx;
        Game.camera.y -= dy;
        
        // Clamp camera
        Game.camera.x = Math.max(0, Math.min(CONFIG.MAP_SIZE - canvas.width, Game.camera.x));
        Game.camera.y = Math.max(0, Math.min(CONFIG.MAP_SIZE - canvas.height, Game.camera.y));
        
        Game.lastMouse = { x: e.clientX, y: e.clientY };
    }
}

function onMouseUp() {
    Game.isDragging = false;
}

function onWheel(e) {
    // Future: implement zoom
}

function onClick(e) {
    const worldX = e.clientX + Game.camera.x;
    const worldY = e.clientY + Game.camera.y;
    
    // Check if clicked on building
    const clicked = Game.buildings.find(b => 
        worldX >= b.x && worldX < b.x + CONFIG.TILE_SIZE &&
        worldY >= b.y && worldY < b.y + CONFIG.TILE_SIZE
    );
    
    if (clicked) {
        selectBuilding(clicked);
    } else {
        Game.selectedTile = null;
        document.getElementById('selectionInfo').classList.remove('active');
    }
}

function onTouchStart(e) {
    if (e.touches.length === 1) {
        Game.isDragging = true;
        Game.lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
}

function onTouchMove(e) {
    e.preventDefault();
    if (Game.isDragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - Game.lastMouse.x;
        const dy = e.touches[0].clientY - Game.lastMouse.y;
        Game.camera.x -= dx;
        Game.camera.y -= dy;
        Game.camera.x = Math.max(0, Math.min(CONFIG.MAP_SIZE - canvas.width, Game.camera.x));
        Game.camera.y = Math.max(0, Math.min(CONFIG.MAP_SIZE - canvas.height, Game.camera.y));
        Game.lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
}

function onTouchEnd() {
    Game.isDragging = false;
}

// ============================================================
// BUILDINGS
// ============================================================
function initBuildings() {
    // Start with a castle in the center
    Game.buildings.push({
        type: 'castle',
        x: CONFIG.MAP_SIZE / 2 - CONFIG.TILE_SIZE / 2,
        y: CONFIG.MAP_SIZE / 2 - CONFIG.TILE_SIZE / 2,
        level: 1
    });
    
    // Add some starting buildings
    addBuilding('farm', CONFIG.MAP_SIZE/2 - 200, CONFIG.MAP_SIZE/2);
    addBuilding('barracks', CONFIG.MAP_SIZE/2 + 100, CONFIG.MAP_SIZE/2);
    
    renderBuildingsList();
}

function addBuilding(type, x, y) {
    Game.buildings.push({ type, x, y, level: 1 });
}

function renderBuildingsList() {
    const list = document.getElementById('buildingsList');
    list.innerHTML = '';
    
    Object.entries(BUILDINGS).forEach(([key, b]) => {
        const canAfford = canAffordBuilding(key);
        const card = document.createElement('div');
        card.className = 'building-card';
        card.innerHTML = `
            <div class="building-card-header">
                <span class="building-card-icon">${b.icon}</span>
                <span class="building-card-name">${b.name}</span>
            </div>
            <div class="building-card-desc">${b.desc}</div>
            <div class="building-card-cost">
                ${Object.entries(b.cost).map(([res, amt]) => `
                    <span class="cost-item ${Game.resources[res] >= amt ? 'affordable' : 'expensive'}">
                        ${getResourceIcon(res)} ${amt}
                    </span>
                `).join('')}
            </div>
        `;
        card.onclick = () => buildStructure(key);
        list.appendChild(card);
    });
}

function canAffordBuilding(type) {
    const cost = BUILDINGS[type].cost;
    return Object.entries(cost).every(([res, amt]) => Game.resources[res] >= amt);
}

function buildStructure(type) {
    if (!canAffordBuilding(type)) {
        notify('Insufficient Resources', 'You need more resources to build this.');
        return;
    }
    
    // Deduct cost
    const cost = BUILDINGS[type].cost;
    Object.entries(cost).forEach(([res, amt]) => {
        Game.resources[res] -= amt;
    });
    
    // Find empty spot
    const x = CONFIG.MAP_SIZE/2 + (Math.random() - 0.5) * 400;
    const y = CONFIG.MAP_SIZE/2 + (Math.random() - 0.5) * 400;
    
    addBuilding(type, x, y);
    updateUI();
    notify('Construction Complete!', BUILDINGS[type].name + ' has been built.');
}

function selectBuilding(building) {
    Game.selectedTile = building;
    const info = BUILDINGS[building.type];
    document.getElementById('selectionName').textContent = info.icon + ' ' + info.name + ' (Lv.' + building.level + ')';
    document.getElementById('selectionDesc').textContent = info.desc;
    document.getElementById('selectionInfo').classList.add('active');
}

// ============================================================
// ARMY
// ============================================================
function renderArmyList() {
    const list = document.getElementById('armyList');
    list.innerHTML = '';
    
    Object.entries(UNITS).forEach(([key, u]) => {
        const count = Game.army[key] || 0;
        const card = document.createElement('div');
        card.className = 'unit-card';
        card.innerHTML = `
            <span class="unit-icon">${u.icon}</span>
            <div class="unit-info">
                <div class="unit-name">${u.name}</div>
                <div class="unit-stats">‚öîÔ∏è${u.attack} üõ°Ô∏è${u.defense} üí®${u.speed}</div>
            </div>
            <span class="unit-count">${count}</span>
        `;
        list.appendChild(card);
    });
    
    // Train button
    const trainBtn = document.createElement('button');
    trainBtn.className = 'btn btn-small';
    trainBtn.style.width = '100%';
    trainBtn.style.marginTop = '1rem';
    trainBtn.textContent = '‚öîÔ∏è Train Units';
    trainBtn.onclick = () => trainUnits();
    list.appendChild(trainBtn);
}

function trainUnits() {
    if (Game.resources.gold >= 100 && Game.resources.food >= 50) {
        Game.resources.gold -= 100;
        Game.resources.food -= 50;
        Game.army.infantry += 5;
        updateUI();
        renderArmyList();
        notify('Training Complete!', '5 Infantry have joined your army.');
    } else {
        notify('Insufficient Resources', 'Need 100 gold and 50 food to train units.');
    }
}

// ============================================================
// KINGDOM
// ============================================================
function renderKingdomInfo() {
    const info = document.getElementById('kingdomInfo');
    const power = calculatePower();
    
    info.innerHTML = `
        <div style="text-align:center;margin-bottom:1.5rem">
            <div style="font-size:3rem">${Game.kingdom.banner}</div>
            <h3 style="font-family:'Cinzel';color:var(--gold);margin:0.5rem 0">${Game.kingdom.name}</h3>
            <p style="color:var(--text-dim)">Lord ${Game.user.username}</p>
        </div>
        
        <div class="building-card">
            <div class="building-card-header">
                <span>‚ö° Kingdom Power</span>
                <span style="color:var(--gold)">${formatNumber(power)}</span>
            </div>
        </div>
        
        <div class="building-card">
            <div class="building-card-header">
                <span>üè∞ Buildings</span>
                <span style="color:var(--gold)">${Game.buildings.length}</span>
            </div>
        </div>
        
        <div class="building-card">
            <div class="building-card-header">
                <span>‚öîÔ∏è Army Size</span>
                <span style="color:var(--gold)">${getTotalTroops()}</span>
            </div>
        </div>
        
        <div class="building-card">
            <div class="building-card-header">
                <span>üìä Level</span>
                <span style="color:var(--gold)">${Game.level}</span>
            </div>
        </div>
    `;
}

function calculatePower() {
    let power = 0;
    power += Game.army.infantry * 10;
    power += Game.army.archers * 15;
    power += Game.army.cavalry * 25;
    power += Game.buildings.length * 50;
    return power;
}

// ============================================================
// ALLIANCE
// ============================================================
function renderAllianceInfo() {
    const info = document.getElementById('allianceInfo');
    
    if (!Game.alliance) {
        info.innerHTML = `
            <p style="text-align:center;color:var(--text-dim);margin-bottom:1.5rem">
                You are not part of any alliance. Create or join one to gain powerful allies!
            </p>
            <button class="btn" style="width:100%;margin-bottom:0.5rem" onclick="createAlliance()">üè¥ Create Alliance</button>
            <button class="btn" style="width:100%" onclick="searchAlliance()">üîç Search Alliances</button>
        `;
    } else {
        info.innerHTML = `
            <div style="text-align:center;margin-bottom:1rem">
                <h3 style="font-family:'Cinzel';color:var(--gold)">${Game.alliance.name}</h3>
                <p style="color:var(--text-dim)">Members: ${Game.alliance.members || 1}</p>
            </div>
        `;
    }
}

function createAlliance() {
    const name = prompt('Enter alliance name:');
    if (name && name.length >= 3) {
        Game.alliance = { name, members: 1, leader: Game.user.username };
        renderAllianceInfo();
        notify('Alliance Created!', 'You are now the leader of ' + name);
    }
}

function searchAlliance() {
    notify('Coming Soon', 'Alliance search will be available in multiplayer mode.');
}

// ============================================================
// RESOURCES
// ============================================================
function startResourceLoop() {
    setInterval(() => {
        // Calculate production from buildings
        Game.buildings.forEach(b => {
            const info = BUILDINGS[b.type];
            if (info.provides) {
                Object.entries(info.provides).forEach(([res, amt]) => {
                    if (Game.resources[res] !== undefined) {
                        Game.resources[res] += amt * b.level;
                    }
                });
            }
        });
        
        updateUI();
    }, CONFIG.RESOURCE_TICK);
}

function getResourceIcon(res) {
    const icons = { gold: 'üí∞', food: 'üåæ', iron: '‚öîÔ∏è', troops: 'üõ°Ô∏è' };
    return icons[res] || '‚ùì';
}

// ============================================================
// PANELS
// ============================================================
let activePanel = null;

function togglePanel(name) {
    const panel = document.getElementById('panel-' + name);
    const btn = document.getElementById('btn-' + name);
    
    // Close other panels
    document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
    
    if (activePanel === name) {
        activePanel = null;
    } else {
        panel.classList.add('active');
        btn.classList.add('active');
        activePanel = name;
        
        // Render content
        if (name === 'build') renderBuildingsList();
        if (name === 'army') renderArmyList();
        if (name === 'kingdom') renderKingdomInfo();
        if (name === 'alliance') renderAllianceInfo();
    }
}

function closePanel() {
    document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
    activePanel = null;
}

// ============================================================
// CHAT
// ============================================================
function toggleChat() {
    document.getElementById('chatContainer').classList.toggle('active');
    document.getElementById('btn-chat').classList.toggle('active');
}

function sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    addChatMessage(Game.user.username, msg);
    input.value = '';
}

function addChatMessage(sender, text) {
    const messages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.innerHTML = `<span class="sender">[${sender}]:</span> <span class="text">${text}</span>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendChat();
});

// ============================================================
// BATTLE
// ============================================================
function showBattle(enemy) {
    document.getElementById('battle-attacker').textContent = Game.user.username + "'s Army";
    document.getElementById('battle-attacker-power').textContent = 'Power: ' + calculatePower();
    document.getElementById('battle-defender').textContent = enemy.name;
    document.getElementById('battle-defender-power').textContent = 'Power: ' + enemy.power;
    document.getElementById('battleModal').classList.add('active');
}

function closeBattle() {
    document.getElementById('battleModal').classList.remove('active');
}

function startBattle() {
    closeBattle();
    notify('Victory!', 'You have won the battle! Rewards: 500 gold, 200 iron');
    Game.resources.gold += 500;
    Game.resources.iron += 200;
    updateUI();
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function notify(title, text) {
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.innerHTML = `
        <div class="notification-title">${title}</div>
        <div class="notification-text">${text}</div>
    `;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}
</script>
</body>
</html>
